# EEI Composition Format

This format describes how to serialize a composition of the **Entity-Environment-Interaction** (EEI) model used by the editor. It targets `*.eei.json` files located in `game/configs/compositions/` or any project folder you want under version control.

## Goals

- Persist the `Environment` â†’ `Entity` tree generated by the editor.
- Preserve instance-specific settings (positions, radii, custom state).
- Declare explicit interactions between nodes without embedding Python logic.
- Keep the format readable and easy to migrate between template versions.

## General structure

```json
{
  "version": 1,
  "metadata": {
    "name": "Readable name",
    "description": "Optional notes",
    "tags": ["prototype", "boss-room"]
  },
  "scene": {
    "canvas": [1028, 720],
    "origin": [0, 0]
  },
  "nodes": [],
  "interactions": []
}
```

- `version`: integer to support schema migrations later.
- `metadata`: freeform block to identify the composition.
- `scene`: global canvas/scene data.
- `nodes`: linear list of all elements (`Environment` or `Entity`).
- `interactions`: optional list of explicit relationships (triggers, event sends, etc.).

## Node (`nodes[]`)

Each tree element is an object with these keys:

```json
{
  "id": "env-001",
  "kind": "environment",
  "type": "game.environments.BlackZone",
  "parent": null,
  "transform": {
    "position": [360, 240],
    "rotation": 0.0,
    "scale": [1.0, 1.0]
  },
  "state": {
    "dims": [200, 200]
  },
  "children": ["ent-eye-1", "ent-mouth-1"]
}
```

- `id`: unique identifier in the file (prefix `env-` or `ent-` is recommended).
- `kind`: `"environment"` or `"entity"`. Defines which class is instantiated.
- `type`: importable class path (e.g. `game.entities.Eye`). This lets the editor/CLI resolve the factory.
- `parent`: `null` for nodes hanging from `Scene Root`. For entities, it must point to the parent environment id. For environments, it can be `null` or point to an entity id (never to another environment, per `core/core_model`).
- `transform`: generic block. `position` is required; `rotation` and `scale` are optional and may be omitted when not used.
- `state`: freeform dict with type-specific parameters (radius, timers, flags). Each editor factory decides which keys to use.
- `children`: derived list that helps rebuild the tree without sorting by `parent`. It may be omitted if rebuilt at load time, but keeping it is recommended for debugging.

## Interaction (`interactions[]`)

Interactions describe how one node influences another without embedded code:

```json
{
  "id": "int-blink-mouth",
  "source": "ent-eye-1",
  "target": "ent-mouth-1",
  "kind": "event",
  "trigger": {
    "event": "blink.finished",
    "conditions": {
      "min_open_time": 0.1
    }
  },
  "effect": {
    "action": "toggle",
    "args": {"field": "talking"}
  }
}
```

- `source` and `target` reference valid node `id` values.
- `kind` is freeform, but suggested values include `event`, `physics`, `audio`, `custom`.
- `trigger` and `effect` are generic blocks for conditions/actions. Runtime systems can interpret them however they want (e.g., translate them into game events or scripts).
- Interactions can link environment-to-environment or entity-to-environment, as long as the ids exist.

## Full example

```json
{
  "version": 1,
  "metadata": {
    "name": "demo-face",
    "description": "Eye and mouth inside a BlackZone",
    "tags": ["demo", "eei"]
  },
  "scene": {
    "canvas": [1028, 720],
    "origin": [0, 0]
  },
  "nodes": [
    {
      "id": "env-blackzone-1",
      "kind": "environment",
      "type": "game.environments.BlackZone",
      "parent": null,
      "transform": {"position": [360, 240]},
      "state": {"dims": [280, 220]},
      "children": ["ent-eye-1", "ent-mouth-1"]
    },
    {
      "id": "ent-eye-1",
      "kind": "entity",
      "type": "game.entities.Eye",
      "parent": "env-blackzone-1",
      "transform": {"position": [320, 220]},
      "state": {"blink_duration": 0.12}
    },
    {
      "id": "ent-mouth-1",
      "kind": "entity",
      "type": "game.entities.Mouth",
      "parent": "env-blackzone-1",
      "transform": {"position": [400, 280]},
      "state": {"open_speed": 8.0}
    }
  ],
  "interactions": [
    {
      "id": "int-eye-mouth",
      "source": "ent-eye-1",
      "target": "ent-mouth-1",
      "kind": "event",
      "trigger": {"event": "blink.started"},
      "effect": {"action": "set", "args": {"field": "talking", "value": true}}
    }
  ]
}
```

This example follows the rules in `game/core/core_model`: environments hang from the root or from entities, and entities always belong to an environment. It also shows how an interaction can coordinate behavior without duplicating Python logic.
